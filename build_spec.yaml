version: 0.1
component: build
timeoutInSeconds: 1800
shell: bash

env:
  variables:
    REGISTRY: "mx-queretaro-1.ocir.io"
    NAMESPACE: "ax29jagffjqz"
    REPO: "reacttodo/bh2ij/todolistapp-springboot"
  exportedVariables:
    - BUILDRUN_HASH

steps:
  - type: Command
    name: Login to OCIR
    command: |
      echo "ðŸ”‘ Autenticando en OCIR..."
      echo $OCI_AUTH_TOKEN | docker login $REGISTRY -u $OCI_USERNAME --password-stdin

  - type: Command
    name: Define unique image tag
    command: |
      BUILDRUN_HASH=$(echo $OCI_BUILD_RUN_ID | cut -c1-7)
      echo "BUILDRUN_HASH: $BUILDRUN_HASH"
      export BUILDRUN_HASH

  - type: Command
    name: Permisos a mvnw
    command: |
      cd MtdrSpring/backend
      chmod +x mvnw

  - type: Command
    name: Build Java Project
    command: |
      cd MtdrSpring/backend
      ./mvnw clean package -DskipTests

  - type: Command
    name: Verificar JAR
    command: |
      cd MtdrSpring/backend
      ls -lh target/

  - type: Command
    name: Build & Push Docker Image
    command: |
      cd MtdrSpring/backend
      docker build \
        -t ${REGISTRY}/${NAMESPACE}/${REPO}:${BUILDRUN_HASH} \
        .
      docker push ${REGISTRY}/${NAMESPACE}/${REPO}:${BUILDRUN_HASH}